   <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAPHIR LIVE | Votez pour le morceau</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Montserrat:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00e5ff; --bg: #050505; }
        body { 
            background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; 
            margin: 0; padding: 20px; text-align: center; overflow-x: hidden;
           transition: background-color 0.8s ease; /* Transition douce pour un effet immersif */
           background-color: var(--bg);
        }

       #session-badge {
    display: inline-block;
    background: rgba(0, 229, 255, 0.1);
    border: 1px solid var(--neon);
    color: var(--neon);
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: bold;
    letter-spacing: 2px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
    text-transform: uppercase;
}

#display-session-id {
    font-size: 0.9rem;
}
       
        h1 { font-family: 'Cinzel', serif; color: var(--neon); letter-spacing: 5px; margin-bottom: 5px; }
        p { opacity: 0.7; font-size: 0.9rem; margin-bottom: 30px; }

        .vote-container { display: flex; flex-direction: column; gap: 20px; max-width: 400px; margin: 0 auto; }
        
        .choice-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(0, 229, 255, 0.2);
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .choice-card:active { transform: scale(0.95); background: rgba(0, 229, 255, 0.1); }
        .choice-card.selected { border-color: var(--neon); box-shadow: 0 0 20px var(--neon); background: rgba(0, 229, 255, 0.05); }

        h3 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; }
        
        #status-msg { margin-top: 30px; font-size: 0.8rem; color: var(--neon); opacity: 0; transition: 0.5s; }
        .visible { opacity: 1 !important; }
       
    </style>
</head>
<body>
    <div id="session-badge">SESSION <span id="display-session-id">1</span></div>
    <h1>SAPHIR</h1>
    <p>Choisissez la suite du concert</p>

    <div class="vote-container">
        <div class="choice-card" id="btn-m1" onclick="submitVote('m1')">
            <h3 id="label-m1">Chargement...</h3>
        </div>
        <div class="choice-card" id="btn-m2" onclick="submitVote('m2')">
            <h3 id="label-m2">Chargement...</h3>
        </div>
        <div class="choice-card" id="btn-m3" onclick="submitVote('m3')">
            <h3 id="label-m3">Chargement...</h3>
        </div>
    </div>

    <div id="status-msg">VOTE ENREGISTRÉ !</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
    const firebaseConfig = {
  apiKey: "AIzaSyDXOd8Sb_TsiYqwbebCnXTdZGimeheesR4",
  authDomain: "saphir-live.firebaseapp.com",
  projectId: "saphir-live",
  storageBucket: "saphir-live.firebasestorage.app",
  messagingSenderId: "719917557935",
  appId: "1:719917557935:web:3a7a4e1a846732c1afcc5a",
  measurementId: "G-VQQ9H234NB"
};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentPollId = "1";

   onValue(ref(db, 'config/current_active_id'), (snapshot) => {
    const activeId = snapshot.val() || "1";
    currentPollId = activeId.toString();

    // AJOUTE CETTE LIGNE ICI :
    document.getElementById('display-session-id').innerText = currentPollId;

    // Le reste de ta logique (verifierStatutVote, loadTitles...)
    verifierStatutVote();
    loadTitles(currentPollId);
});

    // 1. GÉNÉRER UN ID UNIQUE FIXE POUR CE NAVIGATEUR
    function getDeviceID() {
        let id = localStorage.getItem('saphir_uid');
        if (!id) {
            id = 'USR-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            localStorage.setItem('saphir_uid', id);
        }
        return id;
    }
    const myID = getDeviceID();

    // 2. ÉCOUTER LE CHANGEMENT DE SESSION (F1)
    onValue(ref(db, 'config/current_active_id'), (snapshot) => {
        currentPollId = (snapshot.val() || "1").toString();
        verifierStatutVote(); // On vérifie IMMÉDIATEMENT si on a déjà voté
        loadTitles(currentPollId);
    });

    // ÉCOUTER LA COULEUR D'AMBIANCE EN TEMPS RÉEL
onValue(ref(db, 'config/room_color'), (snapshot) => {
    const newColor = snapshot.val() || "#050505";
    
    // On change le fond du body
    document.body.style.backgroundColor = newColor;
    
    // Optionnel : Si la couleur est très claire, on met le texte en noir pour qu'il reste lisible
    const rgb = hexToRgb(newColor);
    if (rgb && (rgb.r * 0.299 + rgb.g * 0.587 + rgb.b * 0.114) > 186) {
        document.body.style.color = "#000000";
    } else {
        document.body.style.color = "#ffffff";
    }
});

// Petite fonction utilitaire pour la lisibilité du texte
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

    // 3. LA FONCTION CLÉ : VÉRIFIER SUR FIREBASE
    async function verifierStatutVote() {
        const snapshot = await get(ref(db, `check_votes/session_${currentPollId}/${myID}`));
        
        const cards = document.querySelectorAll('.choice-card');
        const msg = document.getElementById('status-msg');

        if (snapshot.exists()) {
            // DÉJÀ VOTÉ : On bloque tout
            const monChoix = snapshot.val();
            cards.forEach(card => {
                card.style.pointerEvents = 'none';
                card.classList.remove('selected');
                card.style.opacity = "0.5";
            });
            document.getElementById('btn-' + monChoix).classList.add('selected');
            document.getElementById('btn-' + monChoix).style.opacity = "1";
            msg.innerText = "VOTE DÉJÀ ENREGISTRÉ";
            msg.classList.add('visible');
        } else {
            // PAS ENCORE VOTÉ : On libère
            cards.forEach(card => {
                card.style.pointerEvents = 'auto';
                card.style.opacity = "1";
                card.classList.remove('selected');
            });
            msg.classList.remove('visible');
        }
    }

    // 4. ACTION DE VOTER
    window.submitVote = async function(choiceId) {
        // Sécurité serveur : on vérifie si l'ID existe avant d'incrémenter
        const check = await get(ref(db, `check_votes/session_${currentPollId}/${myID}`));
        if (check.exists()) return;

        // Étape A : Enregistrer l'ID de l'utilisateur pour cette session
        await set(ref(db, `check_votes/session_${currentPollId}/${myID}`), choiceId);

        // Étape B : Incrémenter le compteur global (pour tes barres)
        const voteRef = ref(db, `votes/session_${currentPollId}/${choiceId}`);
        await runTransaction(voteRef, (val) => (val || 0) + 1);

        // Étape C : Mettre à jour l'interface
        verifierStatutVote();
    };

       // 2. CHARGER LES TITRES DYNAMIQUEMENT
        function loadTitles(id) {
            onValue(ref(db, `config/session_${id}/titles`), (snap) => {
                const titles = snap.val() || { m1: "Choix 1", m2: "Choix 2", m3: "Choix 3" };
                document.getElementById('label-m1').innerText = titles.m1;
                document.getElementById('label-m2').innerText = titles.m2;
                document.getElementById('label-m3').innerText = titles.m3;
            });
        }
    </script>
</body>
</html>

</html>
